const { onSchedule } = require("firebase-functions/v2/scheduler");
const { initializeApp } = require("firebase-admin/app");
const { getFirestore } = require("firebase-admin/firestore");
const { getMessaging } = require("firebase-admin/messaging");

initializeApp();

exports.enviarRecordatoriosDePago = onSchedule({
    schedule: "every day 09:00",
    timeZone: "America/Argentina/Buenos_Aires",
}, async (event) => {
    console.log("Ejecutando la función de recordatorios de pago.");
    const db = getFirestore();
    const messaging = getMessaging();

    const hoy = new Date();
    // Establecer la hora a medianoche para comparaciones de día completo
    const inicioHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

    const usuariosSnapshot = await db.collection("users").get();

    for (const userDoc of usuariosSnapshot.docs) {
        const userId = userDoc.id;
        const userData = userDoc.data();

        if (userData.fcmToken) {
            const pagosSnapshot = await db.collection("users").doc(userId).collection("payments").get();

            for (const paymentDoc of pagosSnapshot.docs) {
                const pago = paymentDoc.data();
                
                // **LÓGICA DE FECHA CORREGIDA**
                let fechaVencimiento = new Date(hoy.getFullYear(), hoy.getMonth(), pago.dueDate);
                
                // Si la fecha de vencimiento de este mes ya pasó, calcular para el mes siguiente.
                if (fechaVencimiento < inicioHoy) {
                    fechaVencimiento.setMonth(fechaVencimiento.getMonth() + 1);
                }

                const mesAnioVencimiento = `${fechaVencimiento.getFullYear()}-${String(fechaVencimiento.getMonth() + 1).padStart(2, "0")}`;
                const yaPagado = pago.paidMonths && pago.paidMonths[mesAnioVencimiento];
                
                // Calcular la diferencia en días de forma precisa
                const diffTime = fechaVencimiento.getTime() - inicioHoy.getTime();
                const diasRestantes = Math.round(diffTime / (1000 * 60 * 60 * 24));

                // Enviar notificación si vence hoy, mañana o pasado mañana (días 0, 1, 2)
                if (!yaPagado && diasRestantes >= 0 && diasRestantes <= 2) {
                    let mensaje;
                    if (diasRestantes === 0) {
                        mensaje = `¡Hoy vence el pago de ${pago.name}!`;
                    } else {
                        mensaje = `El pago de ${pago.name} vence en ${diasRestantes} día(s).`;
                    }

                    const payload = {
                        notification: {
                            title: "Recordatorio de Vencimiento",
                            body: mensaje,
                            icon: "/images/icon-192x192.png",
                        },
                    };
                    
                    console.log(`Enviando notificación a ${userId} por el pago '${pago.name}'. Días restantes: ${diasRestantes}`);
                    try {
                        await messaging.sendToDevice(userData.fcmToken, payload);
                    } catch (error) {
                        console.error("Error al enviar notificación:", error);
                    }
                }
            }
        }
    }
    return null;
});
